<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <style>
        body {
            margin: 0;
            background: #f5f5f7;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
        }
        .wrapper {
            max-width: 960px;
            margin: 40px auto;
            background: #ffffff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            padding: 32px 48px 40px;
        }
        h1 {
            font-size: 20px;
            margin: 0 0 24px 0;
            border-bottom: 2px solid #e5e5e5;
            padding-bottom: 12px;
        }
        .section-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 10px;
        }
        .terms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .terms-header span.label {
            font-size: 14px;
            font-weight: 600;
        }
        .terms-box {
            border: 1px solid #d5d5d5;
            background: #fafafa;
            padding: 12px 14px;
            max-height: 180px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        .terms-box h4 {
            margin: 4px 0 6px;
            font-size: 13px;
        }
        .terms-box p {
            margin: 2px 0;
        }
        .checkbox-row {
            font-size: 13px;
            margin-bottom: 10px;
        }
        .checkbox-row input {
            vertical-align: middle;
        }
        .checkbox-row label {
            margin-left: 4px;
        }
        .all-agree {
            padding: 10px 12px;
            border-radius: 3px;
            background: #f0f3ff;
            border: 1px solid #ccd3ff;
            margin-bottom: 16px;
            font-size: 13px;
        }
        .all-agree strong {
            color: #324b9b;
        }
        .field-row {
            margin-bottom: 12px;
        }
        .field-row label {
            display: inline-block;
            width: 110px;
            font-size: 13px;
        }
        .field-row input[type="text"],
        .field-row input[type="password"] {
            width: 260px;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 13px;
        }
        .field-hint {
            font-size: 11px;
            color: #777;
            margin-left: 110px;
            margin-top: 2px;
        }
        .btn-primary {
            padding: 8px 26px;
            background: #324b9b;
            border: none;
            color: #ffffff;
            font-size: 13px;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-secondary {
            padding: 8px 18px;
            background: #e0e0e0;
            border: none;
            font-size: 13px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 8px;
        }
        .btn-area {
            margin-top: 24px;
            text-align: center;
        }
        .message-error {
            font-size: 12px;
            color: #c62828;
            margin-bottom: 12px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            font-size: 13px;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            background: #f8f8f8;
            margin-right: 4px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: #ffffff;
            font-weight: 600;
            border-bottom: 1px solid #ffffff;
        }
    </style>

    <script>
        // 연속 3글자(숫자/알파벳) 체크
        function hasSequentialTriplet(str) {
            if (!str) return false;
            const lower = str.toLowerCase();

            for (let i = 0; i <= lower.length - 3; i++) {
                const a = lower.charCodeAt(i);
                const b = lower.charCodeAt(i + 1);
                const c = lower.charCodeAt(i + 2);

                const isDigit = ch => ch >= 48 && ch <= 57;
                const isLetter = ch => ch >= 97 && ch <= 122;

                if (isDigit(a) && isDigit(b) && isDigit(c)) {
                    if (b === a + 1 && c === b + 1) return true; // 123
                }
                if (isLetter(a) && isLetter(b) && isLetter(c)) {
                    if (b === a + 1 && c === b + 1) return true; // abc
                }
            }
            return false;
        }

        function updateRule(id, ok) {
            const el = document.getElementById(id);
            if (!el) return;
            el.style.color = ok ? '#2e7d32' : '#c62828'; // 초록 / 빨강
        }

        // 비밀번호 규칙 체크
        function updatePasswordStatus() {
            const pwd = (document.getElementById('password').value || '').trim();
            const username = (document.getElementById('username').value || '').trim();
            const nickname = (document.getElementById('nickname').value || '').trim();

            const lengthOk = pwd.length >= 8 && pwd.length <= 20;
            const hasLetter  = /[A-Za-z]/.test(pwd);
            const hasDigit   = /[0-9]/.test(pwd);
            const hasSpecial = /[^A-Za-z0-9]/.test(pwd);
            const comboOk = (hasLetter && hasDigit) || (hasLetter && hasSpecial) || (hasDigit && hasSpecial);

            const same3 = /(.)\1\1/.test(pwd);           // aaa, 111, !!!
            const sequential = hasSequentialTriplet(pwd); // 123, abc
            const sameAsIdNick = pwd !== '' && (pwd === username || pwd === nickname);

            updateRule('rule-length', lengthOk);
            updateRule('rule-combo', comboOk);
            updateRule('rule-repeat', !same3);
            updateRule('rule-seq', !sequential);
            updateRule('rule-idnick', !sameAsIdNick);

            // 모든 규칙 만족 여부 반환
            return lengthOk && comboOk && !same3 && !sequential && !sameAsIdNick;
        }

        // 비밀번호 일치 여부
        function updatePasswordMatch() {
            const pwd = document.getElementById('password').value || '';
            const pwd2 = document.getElementById('passwordConfirm').value || '';
            const msg = document.getElementById('passwordMatchMsg');

            if (!msg) return;

            if (!pwd && !pwd2) {
                msg.textContent = '';
                return;
            }

            if (pwd === pwd2) {
                msg.textContent = '비밀번호가 일치합니다.';
                msg.style.color = '#2e7d32';
            } else {
                msg.textContent = '비밀번호가 일치하지 않습니다.';
                msg.style.color = '#c62828';
            }
        }

        function toggleAll(source) {
            const checked = source.checked;
            document.getElementById('termsAgree').checked = checked;
            document.getElementById('privacyAgree').checked = checked;
        }

        // submit 직전 최종 체크
        function validateForm() {
            const terms = document.getElementById('termsAgree').checked;
            const privacy = document.getElementById('privacyAgree').checked;
            if (!terms || !privacy) {
                alert('필수 약관에 모두 동의해 주세요.');
                return false;
            }

            const ok = updatePasswordStatus();
            if (!ok) {
                alert('비밀번호가 보안 기준을 만족하지 않습니다.');
                return false;
            }

            const pwd = document.getElementById('password').value || '';
            const pwd2 = document.getElementById('passwordConfirm').value || '';
            if (pwd !== pwd2) {
                alert('비밀번호와 비밀번호 확인이 일치하지 않습니다.');
                return false;
            }

            return true;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const passwordInput = document.getElementById('password');
            const passwordConfirmInput = document.getElementById('passwordConfirm');

            if (passwordInput) {
                passwordInput.addEventListener('input', function () {
                    updatePasswordStatus();
                    updatePasswordMatch();
                });
            }

            if (passwordConfirmInput) {
                passwordConfirmInput.addEventListener('input', updatePasswordMatch);
            }
        });
    </script>
</head>
<body>

<th:block th:replace="fragments/header :: siteHeader"></th:block>


<div class="wrapper">
    <h1>회원가입</h1>

    <!-- 상단 탭 (디시인사이드 느낌) -->
    <div class="tabs">
        <div class="tab active">회원가입 신청(만 14세 이상)</div>
        <div class="tab">만 14세 미만</div>
    </div>

    <form th:action="@{/members/new}" method="post" onsubmit="return validateForm();">
        <!-- _csrf가 없으면(null) 에러 나지 않게 방어 -->
        <input type="hidden"
               th:if="${_csrf != null}"
               th:name="${_csrf.parameterName}"
               th:value="${_csrf.token}"/>

        <!-- 에러 메시지 -->
        <div class="message-error" th:if="${errorMessage != null}" th:text="${errorMessage}"></div>

        <!-- 1. 약관 동의 -->
        <div class="section">
            <div class="section-title">약관 동의</div>

            <div class="all-agree">
                <label>
                    <input type="checkbox" id="allAgree" onclick="toggleAll(this)">
                    <strong>전체 동의하기</strong>
                </label>
                <span style="margin-left:8px; font-size:12px; color:#555;">
                    (필수 항목에 모두 동의합니다)
                </span>
            </div>

            <!-- [필수] 이용약관 -->
            <div class="terms-header">
                <span class="label">[필수] 커뮤니티 이용약관 동의</span>
            </div>
            <div class="terms-box">
                <h4>제1조 (목적)</h4>
                <p>이 약관은 커뮤니티 서비스(이하 "서비스")의 이용과 관련하여 서비스 제공자와 이용자 간의 권리·의무 및 책임사항을 정함을 목적으로 합니다.</p>

                <h4>제2조 (이용자의 정의)</h4>
                <p>① "이용자"란 약관에 동의하고 서비스를 이용하는 회원 및 비회원 이용자를 말합니다.</p>
                <p>② "회원"이란 고정닉(계정)을 신청하여 아이디와 비밀번호를 부여받은 이용자를 말하며, 비회원은 계정 없이 게시판을 이용하는 이용자를 말합니다. 비회원이 작성한 글에는 닉네임 뒤에 일부 IP가 (000.000) 형식으로 표시될 수 있습니다.</p>

                <h4>제3조 (계정 신청)</h4>
                <p>회원은 가입 양식을 작성하고 약관에 동의함으로써 계정을 신청할 수 있습니다. 서비스 제공자는 허위 정보 기재, 서비스 운영에 중대한 지장을 줄 우려가 있는 경우 신청을 제한할 수 있습니다.</p>

                <h4>제4조 (서비스의 제공)</h4>
                <p>서비스는 게시판, 검색, 알림 등 커뮤니티 이용에 필요한 기능을 제공합니다. 구체적인 서비스 내용은 운영 정책에 따라 추가·변경될 수 있습니다.</p>

                <h4>제5조 (서비스의 중단 및 변경)</h4>
                <p>시스템 점검, 장애, 기타 불가피한 사유가 있는 경우 서비스의 일부 또는 전부가 일시 중단될 수 있으며, 이 경우 사전에 공지 가능한 범위에서 공지합니다.</p>

                <h4>제6조 (계정 탈퇴 및 자격 상실)</h4>
                <p>회원은 언제든지 탈퇴를 요청할 수 있습니다. 아래 각 호에 해당하는 경우 서비스 제공자는 회원의 자격을 제한하거나 상실시킬 수 있습니다.</p>
                <p>- 가입 시 허위 정보 기재<br>
                    - 다른 이용자의 계정 도용, 서비스 방해 행위<br>
                    - 불법 정보 게시, 타인의 권리 침해, 공서양속 위반 행위 등</p>

                <h4>제7조 (이용자에 대한 통지)</h4>
                <p>전체 이용자에 대한 통지는 서비스 내 공지사항 게시판에 7일 이상 게시함으로써 갈음할 수 있습니다.</p>

                <h4>제8조 (이용자 정보)</h4>
                <p>서비스 제공자는 계정 운영 및 서비스 제공을 위해 최소한의 정보(식별 코드, 비밀번호, 닉네임, 접속기록, IP, 기기 정보 등)를 수집·보관할 수 있으며, 세부 항목은 개인정보 처리방침에서 안내합니다.</p>

                <h4>제9조 (회사의 의무)</h4>
                <p>서비스 제공자는 관련 법령과 약관을 준수하며 안정적인 서비스 제공을 위해 노력합니다. 단, 천재지변 및 불가항력, 이용자 과실로 인한 손해에 대해서는 책임을 지지 않습니다.</p>

                <h4>제10조 (계정 및 비밀번호의 관리)</h4>
                <p>회원은 자신의 아이디와 비밀번호를 안전하게 관리할 책임이 있으며, 제3자에게 양도·대여할 수 없습니다.</p>

                <h4>제11조 (이용자의 의무)</h4>
                <p>이용자는 다음 행위를 해서는 안 됩니다.</p>
                <p>- 타인의 권리 침해, 명예훼손, 불법 정보 게시<br>
                    - 음란물·청소년유해매체물·불법촬영물 게시<br>
                    - 스팸성 광고, 서비스 취지에 맞지 않는 반복 게시<br>
                    - 자동화 프로그램(봇, 크롤러 등)을 이용한 비정상적인 서비스 이용</p>

                <h4>제12조 (게시물의 관리)</h4>
                <p>게시물이 법령 또는 약관에 위반되거나 타인의 권리를 침해하는 경우, 서비스 제공자는 해당 게시물에 대한 노출 제한 또는 삭제 등의 조치를 취할 수 있습니다.</p>

                <h4>제13조 (저작권 및 콘텐츠 이용)</h4>
                <p>이용자가 작성한 게시물의 저작권은 해당 이용자에게 귀속되나, 서비스 운영·홍보 및 인공지능 모델 학습 등의 목적으로 서비스 제공자가 비영리적으로 이용할 수 있습니다.</p>

                <h4>제14조 (광고 게재)</h4>
                <p>서비스 제공자는 서비스 화면에 광고를 게재할 수 있으며, 이용자는 게시물 내용 및 관심사에 기반한 광고 노출에 동의합니다.</p>

                <h4>제15조 (크롤링 및 인공지능 학습)</h4>
                <p>서비스 내 콘텐츠를 자동 수집하거나 인공지능 학습 데이터로 활용하고자 하는 경우, 반드시 사전에 서면 동의를 받아야 합니다.</p>

                <h4>제16조 (약관의 개정)</h4>
                <p>약관이 개정되는 경우 개정 내용과 적용일자를 사전에 공지하며, 이용자가 공지 후 계속 서비스를 이용하는 경우 변경 약관에 동의한 것으로 봅니다.</p>

                <h4>제17조 (재판관할)</h4>
                <p>서비스 이용과 관련된 분쟁에 대해서는 대한민국 법을 적용하며, 관할 법원은 민사소송법이 정하는 바에 따릅니다.</p>

                <p style="margin-top:6px; font-size:11px; color:#777;">
                    공고일자: 2024년 04월 17일 / 시행일자: 2024년 04월 23일
                </p>
            </div>
            <div class="checkbox-row">
                <label>
                    <input type="checkbox" id="termsAgree" name="termsAgree">
                    위 이용약관에 동의합니다.
                </label>
            </div>

            <!-- [필수] 개인정보 수집 및 이용 -->
            <div class="terms-header" style="margin-top:18px;">
                <span class="label">[필수] 개인정보 수집 및 이용 동의</span>
            </div>
            <div class="terms-box">
                <h4>1. 개인정보 수집 및 이용 목적</h4>
                <p>- 서비스 이용에 따른 이용자 식별, 계정 관리, 부정 이용 및 비인가 사용 방지</p>
                <p>- 만 14세 미만 이용자의 경우 법정대리인 동의 여부 확인</p>
                <p>- 고객 문의 및 민원 처리, 공지사항 전달, 이벤트·개인 맞춤 서비스 제공, 통계·분석 등 서비스 품질 향상을 위한 이용</p>

                <h4>2. 수집 항목</h4>
                <p>&lt;회원 가입 시&gt;</p>
                <p>- 필수: 식별 코드(시스템에서 부여하는 내부 번호), 비밀번호, 닉네임</p>
                <p>&lt;서비스 이용 시 자동 수집&gt;</p>
                <p>- 서비스 이용 기록, 접속 IP, 기기 정보, 브라우저 정보, 불량 이용 기록, 성인 인증값, 쿠키 등</p>
                <p style="font-size:11px; color:#777;">
                    ※ 쿠키는 이용자의 브라우저 및 기기에서 생성·저장되며, 서비스 품질 개선 및 편의 제공을 위해 활용될 수 있습니다.
                </p>

                <h4>3. 보유 및 이용 기간</h4>
                <p>- 회원 탈퇴 시 지체 없이 파기합니다.</p>
                <p>- 11개월 동안 로그인 기록이 없는 계정은 장기 미이용 계정으로 전환되며, 관련 법령에 따라 분리 보관 또는 파기될 수 있습니다.</p>

                <h4>4. 동의 거부 권리 및 불이익</h4>
                <p>이용자는 개인정보 수집 및 이용에 대한 동의를 거부할 권리가 있습니다. 다만, 필수 항목에 대한 동의를 거부하는 경우 회원가입 및 서비스 이용이 제한될 수 있습니다.</p>
            </div>
            <div class="checkbox-row">
                <label>
                    <input type="checkbox" id="privacyAgree" name="privacyAgree">
                    개인정보 수집 및 이용에 동의합니다.
                </label>
            </div>
        </div>

        <!-- 2. 회원 정보 입력 -->
        <div class="section" style="margin-top:28px;">
            <div class="section-title">회원 정보 입력</div>

            <div class="field-row">
                <label for="username">아이디</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="field-hint">영문 소문자/숫자 조합을 권장합니다.</div>

            <div class="field-row" style="margin-top:10px;">
                <label for="password">비밀번호</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="field-row">
                <label for="passwordConfirm">비밀번호 확인</label>
                <input type="password" id="passwordConfirm" name="passwordConfirm" required>
            </div>

            <!-- ✅ 비밀번호 규칙 + 실시간 색상 표시 영역 -->
            <div class="field-hint">
                <div id="rule-length">• 8~20자</div>
                <div id="rule-combo">• 영문/숫자/특수문자 중 2종류 이상 조합</div>
                <div id="rule-repeat">• 동일 문자 3개 연속 금지 (예: 111, aaa, !!!)</div>
                <div id="rule-seq">• 연속 문자/숫자 3개 금지 (예: 123, abc)</div>
                <div id="rule-idnick">• 아이디/닉네임과 동일 금지</div>
            </div>
            <div class="field-hint" id="passwordMatchMsg"></div>
            <!-- 여기까지가 1번 요구사항 실시간 체크 UI -->

            <div class="field-row" style="margin-top:10px;">
                <label for="nickname">닉네임</label>
                <input type="text" id="nickname" name="nickname" required>
            </div>
            <div class="field-hint">
                게시판에 표시될 이름입니다. 언제든지 계정 설정에서 변경할 수 있습니다.
            </div>
        </div>

        <div class="btn-area">
            <button type="submit" class="btn-primary">가입하기</button>
            <button type="button" class="btn-secondary" onclick="location.href='/'">취소</button>
        </div>
    </form>
</div>

</body>
</html>
